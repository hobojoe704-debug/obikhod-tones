<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choir Director's App</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base fonts for the application */
        @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            /* Using a sans-serif for the main body for better readability on screens */
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
            color: #1a1a1a;
            /* Subtle Byzantine-inspired background pattern */
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d1d5db' fill-opacity='0.4'%3E%3Cpath d='M0 16v-2h2v2H0zm2-4V8h2v4H2zm2-4V4h2v4H4zm2-4V0h2v4H6zm2 0h2v2H8V0zm2 0h2v4h-2V0zm2 4h2v4h-2V4zm2 4h2v4h-2V8zm2 4h2v2h-2v-2zm0 2h-2v2h2v-2zm-2 0h-2v2h2v-2zm-4 0h-2v2h2v-2zm-2 0h-2v2h2v-2zm-2 0H6v2H4v-2zm-2 0H2v2h2v-2z'%3E%3C/path%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
        }
        .container-card {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #a67c00;
        }
        .header-bg {
            background-color: #581845;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .tone-button.selected {
            @apply ring-4 ring-blue-500 ring-opacity-50;
        }
        /* Custom styles for tab button appearance */
        .tab-button.selected {
            border-bottom: 4px solid #3b82f6; /* A stronger blue border for emphasis */
            background-color: white;
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06);
            color: #1e40af;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<div class="container-card rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden">
    <!-- Header -->
    <div class="p-6 header-bg text-white text-center border-b border-gold-400">
        <!-- Using a serif font for the title for a liturgical feel -->
        <h1 class="text-3xl font-bold mb-1 font-['EB Garamond']">Obikhod Tones</h1>
        <p class="text-sm opacity-90 font-inter">An interactive tool for practicing liturgical tones.</p>
    </div>

    <!-- Tab Buttons -->
    <div class="flex border-b border-gray-200 bg-gray-100">
        <button id="tab-stichera" class="tab-button flex-1 p-4 text-center font-semibold text-lg text-blue-800 transition-all duration-300 rounded-tl-xl hover:bg-gray-200">
            Stichera
        </button>
        <button id="tab-troparion" class="tab-button flex-1 p-4 text-center font-semibold text-lg text-gray-500 transition-all duration-300 rounded-tr-xl hover:bg-gray-200">
            Troparion
        </button>
    </div>

    <!-- Tab Content -->
    <div id="content-container" class="p-6">
        <!-- Stichera Content -->
        <!-- Responsive grid: 2 columns on small screens, 4 on medium and up -->
        <div id="content-stichera" class="tab-content grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Dynamically populated buttons -->
        </div>

        <!-- Troparion Content (hidden by default) -->
        <!-- Responsive grid: 2 columns on small screens, 4 on medium and up -->
        <div id="content-troparion" class="tab-content hidden grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Dynamically populated buttons -->
        </div>
    </div>
</div>

<script>
    // --- State Management ---
    let audioContext = null;
    let playingSources = [];
    let currentlyPlaying = null;
    const melodies = {
        "stichera": {
            "1": [
                { "notes": ["G4", "Bb4"], "duration": 1.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["E4", "G4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 1.0 },
                { "notes": ["F4", "A4"], "duration": 2.0 }
            ],
            "2": [
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["Bb4", "D5"], "duration": 1.0 },
                { "notes": ["A4", "C5"], "duration": 1.0 },
                { "notes": ["G4", "Bb4"], "duration": 1.5 }
            ],
            "3": [
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 1.0 },
                { "notes": ["E4", "G4"], "duration": 1.5 }
            ],
            "4": [
                { "notes": ["E4", "G4"], "duration": 0.5 },
                { "notes": ["E4", "G4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 1.0 },
                { "notes": ["F4", "A4"], "duration": 1.0 }
            ],
            "5": [
                { "notes": ["G4", "Bb4"], "duration": 1.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["A4", "C5"], "duration": 1.0 },
                { "notes": ["F4", "A4"], "duration": 2.0 }
            ],
            "6": [
                { "notes": ["E4", "G4"], "duration": 0.5 },
                { "notes": ["E4", "G4"], "duration": 0.5 },
                { "notes": ["D#4", "F#4"], "duration": 1.0 },
                { "notes": ["E4", "G4"], "duration": 1.0 }
            ],
            "7": [
                { "notes": ["E4", "G4"], "duration": 1.5 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 1.0 },
                { "notes": ["E4", "G4"], "duration": 2.0 }
            ],
            "8": [
                { "notes": ["F4", "A4"], "duration": 1.5 },
                { "notes": ["E4", "G4"], "duration": 0.5 },
                { "notes": ["E4", "G4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 1.5 },
                { "notes": ["E4", "G4"], "duration": 0.5 },
                { "notes": ["D4", "F4"], "duration": 2.0 }
            ]
        },
        "troparion": {
            "1": [
                { "notes": ["C4", "F4"], "duration": 0.5 },
                { "notes": ["C4", "F4"], "duration": 0.5 },
                { "notes": ["E4", "G4"], "duration": 1.0 },
                { "notes": ["F4", "A4"], "duration": 1.0 }
            ],
            "2": [
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F4", "Bb4"], "duration": 0.5 },
                { "notes": ["F4", "C5"], "duration": 1.0 },
                { "notes": ["F4", "Bb4"], "duration": 1.0 },
                { "notes": ["F4", "A4"], "duration": 1.0 }
            ],
            "3": [
                { "notes": ["B3", "E4"], "duration": 0.5 },
                { "notes": ["D4", "F#4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["D4", "F#4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["F#4", "A4"], "duration": 0.5 },
                { "notes": ["G4", "B4"], "duration": 1.0 }
            ],
            "4": [
                { "notes": ["F4", "A4"], "duration": 1.0 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["G4", "Bb4"], "duration": 0.5 },
                { "notes": ["F#4", "A4"], "duration": 1.0 }
            ],
            "5": [
                { "notes": ["F#4", "A4"], "duration": 1.0 },
                { "notes": ["F#4", "A4"], "duration": 0.5 },
                { "notes": ["F#4", "A4"], "duration": 0.5 },
                { "notes": ["G4", "B4"], "duration": 1.0 },
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 1.0 }
            ],
            "6": [
                { "notes": ["C4", "F4"], "duration": 0.5 },
                { "notes": ["C4", "F4"], "duration": 0.5 },
                { "notes": ["C4", "F4"], "duration": 0.5 },
                { "notes": ["C4", "G4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 1.0 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F#4", "A4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 1.5 }
            ],
            "7": [
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F4", "Bb4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["F4", "A4"], "duration": 0.5 },
                { "notes": ["F4", "Bb4"], "duration": 0.5 }
            ],
            "8": [
                { "notes": ["D4", "G4"], "duration": 0.5 },
                { "notes": ["F#4", "A4"], "duration": 0.5 },
                { "notes": ["G4", "B4"], "duration": 0.5 },
                { "notes": ["G4", "C5"], "duration": 0.5 },
                { "notes": ["G4", "C5"], "duration": 0.5 },
                { "notes": ["G4", "C5"], "duration": 0.5 },
                { "notes": ["G4", "B4"], "duration": 0.5 },
                { "notes": ["G4", "B4"], "duration": 0.5 },
                { "notes": ["F#4", "A4"], "duration": 1.0 },
                { "notes": ["F#4", "A4"], "duration": 0.5 },
                { "notes": ["F#4", "A4"], "duration": 0.5 },
                { "notes": ["D4", "G4"], "duration": 1.0 }
            ]
        }
    };

    // --- DOM Elements ---
    const tabs = {
        stichera: document.getElementById('tab-stichera'),
        troparion: document.getElementById('tab-troparion'),
    };
    const contents = {
        stichera: document.getElementById('content-stichera'),
        troparion: document.getElementById('content-troparion'),
    };

    // --- Utility Functions ---
    // This function normalizes flat notes to their sharp equivalents.
    function normalizeNote(note) {
        if (note.includes('b')) {
            switch (note[0]) {
                case 'B': return `A#${note.slice(-1)}`;
                case 'E': return `D#${note.slice(-1)}`;
                case 'A': return `G#${note.slice(-1)}`;
                case 'D': return `C#${note.slice(-1)}`;
                case 'G': return `F#${note.slice(-1)}`;
                default: return note;
            }
        }
        return note;
    }

    function getFrequency(note) {
        if (note === 'R') return 0;
        const normalizedNote = normalizeNote(note);
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const octave = parseInt(normalizedNote.slice(-1));
        const noteName = normalizedNote.slice(0, -1);
        const semitonesFromA4 = (octave - 4) * 12 + (notes.indexOf(noteName) - 9);
        return 440 * Math.pow(2, semitonesFromA4 / 12);
    }
    
    function stopPlayback() {
        playingSources.forEach(source => {
            try { source.stop(); } catch (e) {}
        });
        playingSources = [];
        currentlyPlaying = null;
        document.querySelectorAll('.tone-button').forEach(btn => btn.classList.remove('selected'));
    }

    function playMelody(melody) {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let startTime = audioContext.currentTime;
        
        melody.forEach(item => {
            if (item.note === 'R') {
                startTime += item.duration;
            } else {
                const notesToPlay = item.notes ? item.notes : [item.note];
                notesToPlay.forEach(noteName => {
                    const frequency = getFrequency(noteName);
                    playNote(frequency, item.duration, startTime);
                });
                startTime += item.duration;
            }
        });
    }

    function playNote(frequency, duration, time) {
        if (!audioContext) return;
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.type = 'sine';
        oscillator.frequency.value = frequency;
        gainNode.gain.setValueAtTime(0, time);
        gainNode.gain.linearRampToValueAtTime(0.5, time + 0.05);
        gainNode.gain.linearRampToValueAtTime(0, time + duration);
        oscillator.start(time);
        oscillator.stop(time + duration);
        playingSources.push(oscillator);
    }

    // --- Event Handlers ---
    function handleToneButtonClick(event) {
        const tone = event.target.dataset.tone;
        const type = event.target.dataset.type;
        const melodyId = `${type}-${tone}`;
        const melody = melodies[type][tone];
        
        // If the same melody is currently playing, stop it.
        if (currentlyPlaying === melodyId) {
            stopPlayback();
        } else {
            // Otherwise, stop any existing playback and start the new one.
            stopPlayback();
            event.target.classList.add('selected');
            currentlyPlaying = melodyId;
            if (melody) {
                playMelody(melody);
            } else {
                console.warn(`Melody for ${type} Tone ${tone} not found.`);
            }
        }
    }

    // --- Dynamic UI Generation ---
    function renderMelodyButtons() {
        // Clear existing buttons
        contents.stichera.innerHTML = '';
        contents.troparion.innerHTML = '';

        // Render Stichera buttons
        for (const tone in melodies.stichera) {
            const button = createButton('stichera', tone);
            contents.stichera.appendChild(button);
        }

        // Render Troparion buttons
        for (const tone in melodies.troparion) {
            const button = createButton('troparion', tone);
            contents.troparion.appendChild(button);
        }
    }

    function createButton(type, tone) {
        const button = document.createElement('button');
        button.classList.add('tone-button', 'transition-all', 'duration-200', 'p-4', 'rounded-lg', 'font-bold', 'shadow-md', 'transform', 'hover:scale-105');
        button.dataset.tone = tone;
        button.dataset.type = type;
        button.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Tone ${tone}`;
        button.addEventListener('click', handleToneButtonClick);
        
        if (type === 'stichera') {
            button.classList.add('bg-blue-100', 'text-blue-800', 'hover:bg-blue-200');
        } else if (type === 'troparion') {
            button.classList.add('bg-amber-100', 'text-amber-800', 'hover:bg-amber-200');
        }
        return button;
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        renderMelodyButtons();

        // Tab switching logic
        tabs.stichera.addEventListener('click', () => switchTab('stichera'));
        tabs.troparion.addEventListener('click', () => switchTab('troparion'));
        
        // Initial switch to Stichera tab
        switchTab('stichera');
    });

    function switchTab(activeTabId) {
        stopPlayback();
        // Hide all content divs first
        for (const id in contents) {
            if (contents[id]) {
                contents[id].classList.add('hidden');
            }
        }
        // Show the selected content div
        if (contents[activeTabId]) {
            contents[activeTabId].classList.remove('hidden');
        }

        // Update tab button styles
        tabs.stichera.classList.remove('selected');
        tabs.troparion.classList.remove('selected');
        tabs[activeTabId].classList.add('selected');
    }
</script>
</body>
</html>
